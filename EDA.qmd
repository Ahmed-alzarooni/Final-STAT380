---
title: "Final-STAT380"
author: "Ahmed alzarooni{style='background-color: yellow;'}"
toc: true
title-block-banner: true
title-block-style: default
execute: 
  freeze: true
  cache: true
format:
  #html: # comment this line to get pdf
   pdf: 
    fig-width: 7
    fig-height: 7
---


---
#### Step 1: Load Necessary Libraries
First, ensure you have the necessary libraries. We'll use readxl to import Excel files and dplyr and ggplot2 for data manipulation and visualization.

We will need the following packages:


```{R, message=FALSE, warning=FALSE, results='hide'}
packages <- c(
  "readxl",
  "tibble",
  "dplyr", 
  "readr", 
  "tidyr", 
  "purrr", 
  "broom",
  "magrittr",
  "corrplot",
  "caret",
  "rpart",
  "rpart.plot",
  "e1071",
  "torch", 
  "luz",
  "stringr",
  "esquisse",
  "randomForest",
  "gbm"
)

#renv::install(packages)
sapply(packages,library, character.only=T)
```

<br><br><br><br>
---

#### Step 2: Read the Data and initial Data Cleaning
Use read_excel to load the data from the Excel files.Check for missing values and decide how to handle them, either by removing or imputing.


```{R}
# Read the datasets
code_income_level <- read_excel("Code and Income Level.xls")
gdp_data <- read_excel("GDP.xls")

Electricity_Access <- read_excel("All.xlsx")

```


---

#### Step 3: Initial Data Examination
Check basic information about the datasets such as dimensions, column names, and a preview of the data.


```{R}
head(code_income_level)
head(gdp_data)
head(Electricity_Access)
```

---

#### Step 4: Data Cleaning
Check for missing values and decide how to handle them, either by removing or imputing.


```{R}
code_income_level <- code_income_level %>%
  mutate(income_level = factor(IncomeGroup, levels = c("Low income", "Lower middle income", "Upper middle income", "High income"), ordered = TRUE))


gdp_data <- gdp_data %>%
  select('Country Name','Country Code', '2000', '2005', '2010', '2015', '2022')


comb_GDP_inc_df <- inner_join(gdp_data, code_income_level, by = "Country Code")
head(comb_GDP_inc_df)
```

```{R}
#Check for identical values
identical_values <- comb_GDP_inc_df$income_level == comb_GDP_inc_df$income_group
sum(!identical_values)
comb_GDP_inc_df_long <- comb_GDP_inc_df %>%
  select(-IncomeGroup)
comb_GDP_inc_df_long <- pivot_longer(comb_GDP_inc_df_long, 
                                        cols = c('2000', '2005', '2010', '2015', '2022'), 
                                        names_to = "Year", 
                                        values_to = "GDP")

comb_GDP_inc_df_long <- na.omit(comb_GDP_inc_df_long)
colnames(comb_GDP_inc_df_long)

```

```{R}
Electricity_Access <- Electricity_Access %>%
  mutate(across(where(is.character) & !all_of("Country"), ~str_replace(., ">99%", "0.990"))) %>%
  mutate(across(where(is.character) & !all_of("Country"), as.numeric)) %>%
  mutate(across(where(is.numeric), round, digits = 3))

Electricity_Access_long <- pivot_longer(Electricity_Access, 
                                        cols = c('2000', '2005', '2010', '2015', '2022'), 
                                        names_to = "Year", 
                                        values_to = "Access")
Electricity_Access_long <- rename(Electricity_Access_long, 'Country Name' = 'Country')
head(Electricity_Access)
head(Electricity_Access_long)
```

```{R}

data_merged <- inner_join(Electricity_Access_long, comb_GDP_inc_df_long, by = c("Country Name", "Year"))
data_merged <- na.omit(data_merged)

summary(data_merged)
```



---

#### Step 5: Summary Statistics
Get a statistical summary of the datasets to understand the distribution of data.

```{R}
summary(comb_GDP_inc_df)
summary(Electricity_Access)

```

#### Step 6: Analysis
###### Analyze basic statistics of electrification rates and GDP

```{R}
# Filter for "Low income" and "Lower middle income" countries
ldc_data <- data_merged %>% 
  filter(income_level %in% c("Low income", "Lower middle income"))

# Analyze basic statistics of electrification rates and GDP
ldc_stats <- ldc_data %>% 
  group_by('Country Name') %>% 
  summarise(
    Average_Access = mean(Access, na.rm = TRUE),
    Min_Access = min(Access, na.rm = TRUE),
    Max_Access = max(Access, na.rm = TRUE),
    Average_GDP = mean(GDP, na.rm = TRUE),
    Min_GDP = min(GDP, na.rm = TRUE),
    Max_GDP = max(GDP, na.rm = TRUE)
  )
print(ldc_stats)

```
###### scatter plot to explore the relationship between electrification rates and GDP
```{R}
ggplot(ldc_data, aes(x=Access, y=GDP, color=income_level)) +
  geom_point() +
  labs(title = "Relationship between Access to Electricity and GDP in LDCs",
       x = "Electrification Rate (Access)",
       y = "GDP per capita (USD)",
       color = "Income Level") +
  theme_minimal()
```
###### Identify countries with the lowest 10% of electrification rates

```{R}
# Identify countries with the lowest 10% of electrification rates
threshold <- quantile(ldc_data$Access, 0.10, na.rm = TRUE)
low_electrification <- ldc_data %>% 
  filter(Access <= threshold)
print(low_electrification %>% 
        select('Country Name', Year, Access, GDP) %>% 
        arrange(Access))

# Save the plot
ggsave("Electrification_GDP_Relationship.png", width = 10, height = 6)
```


---

#### Step 7: Model Training

```{R}
set.seed(123)  # for reproducibility
training_rows <- sample(1:nrow(ldc_data), 0.8 * nrow(ldc_data))
train_data <- ldc_data[training_rows, ]
test_data <- ldc_data[-training_rows, ]
```

```{R}
model <- randomForest(Access ~ GDP + Year, data = train_data, ntree = 100)
print(model)
```
```{R}
# Predict on the testing data
predictions <- predict(model, test_data)

# Calculate Mean Absolute Error (MAE) as a simple performance metric
mae <- mean(abs(predictions - test_data$Access))
print(paste("Mean Absolute Error: ", mae))
```

```{R}
new_data <- data.frame(GDP = c(500, 1000), Year = c(2022, 2022))
predicted_access <- predict(model, new_data)
print(predicted_access)
```


---




:::{.hidden unless-format="pdf"}
\pagebreak
:::

<br><br><br><br>
<br><br><br><br>
---



::: {.callout-note collapse="true"}
## Session Information

Print your `R` session information using the following command

```{R}
sessionInfo()
```
:::